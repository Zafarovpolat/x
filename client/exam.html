<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сайт-помощник</title>
    <link rel="stylesheet" href="./style.css">
    <style>
        .client-section {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .client-header {
            display: flex;
            align-items: center;
        }
        .timer {
            margin-left: 10px;
            font-size: 18px;
            color: #333;
        }
        .questions {
            margin-top: 10px;
        }
        .question {
            margin-bottom: 15px;
        }
        .answers {
            list-style: none;
            padding: 0;
        }
        .answers li {
            margin: 5px 0;
            cursor: pointer;
        }
        .answer-img {
            max-width: 100px;
        }
        button {
            cursor: pointer;
            padding: 5px 10px;
        }
        .answered-question label {
            background-color: #d4edda; /* Light green for answered questions */
            border-color: #28a745;
        }
        .answered-question input[type="radio"]:checked + span {
            font-weight: bold;
            color: #155724;
        }
    </style>
</head>

<body>
    <section class="main">
        <div class="container">
            <div id="auth-check" style="display: none;">
                <h2>Требуется авторизация</h2>
                <p>Пожалуйста, <a href="./index.html">войдите</a> для доступа к помощнику.</p>
            </div>
            <div id="exam-content" style="display: none;">
                <h2>Помощник для экзамена</h2>
                <div id="clients"></div>
            </div>
        </div>
    </section>

    <script>
        // Проверка авторизации
        if (localStorage.getItem('isAuthenticated') !== 'true') {
            document.getElementById('auth-check').style.display = 'block';
        } else {
            document.getElementById('exam-content').style.display = 'block';
            startExam();
        }

        function startExam() {
            const socket = new WebSocket('wss://x-q63z.onrender.com');
            const clientsDiv = document.getElementById('clients');
            const clientsData = {}; // Stores question containers for each client
            const clientAnswers = {}; // Stores answers for each client

            socket.onopen = () => {
                console.log('WebSocket подключен на сайте-помощнике');
                socket.send(JSON.stringify({ role: 'exam' }));
            };

            function renderExam(data) {
                const { clientId, userInfo, question, questionImg, qIndex, answers, timer, userAnswer } = data; // Added userAnswer

                let clientSection = document.querySelector(`.client-section[data-client-id="${clientId}"]`);
                if (!clientSection) {
                    clientSection = document.createElement('div');
                    clientSection.classList.add('client-section');
                    clientSection.dataset.clientId = clientId;

                    const headerDiv = document.createElement('div');
                    headerDiv.classList.add('client-header');

                    const toggleButton = document.createElement('button');
                    const timerSpan = document.createElement('span');
                    timerSpan.classList.add('timer');
                    timerSpan.textContent = timer || '00:00:00';

                    toggleButton.appendChild(document.createTextNode(userInfo || `Клиент ${clientId}`));
                    toggleButton.appendChild(timerSpan);

                    toggleButton.addEventListener('click', () => {
                        const questionsDiv = clientSection.querySelector('.questions');
                        questionsDiv.style.display = (questionsDiv.style.display === 'none' || !questionsDiv.style.display) ? 'block' : 'none';
                    });

                    headerDiv.appendChild(toggleButton);

                    const questionsDiv = document.createElement('div');
                    questionsDiv.classList.add('questions');
                    questionsDiv.style.display = 'none'; // По умолчанию скрыто

                    clientSection.appendChild(headerDiv);
                    clientSection.appendChild(questionsDiv);
                    clientsDiv.appendChild(clientSection);

                    clientsData[clientId] = questionsDiv;
                    clientAnswers[clientId] = clientAnswers[clientId] || {}; // Initialize answers for this client
                } else {
                    // Обновляем таймер, если он пришел в данных
                    if (timer) {
                        const timerSpan = clientSection.querySelector('.timer');
                        timerSpan.textContent = timer;
                    }
                }

                const uniqueId = `${clientId}-${qIndex}`;
                if (clientsData[clientId].querySelector(`.question[data-unique-id="${uniqueId}"]`)) {
                    // If question already exists, just update its state if an answer is provided
                    if (userAnswer !== undefined) {
                        updateAnswerDisplay(clientId, qIndex, userAnswer);
                    }
                    return;
                }

                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');
                questionDiv.dataset.uniqueId = uniqueId;

                if (question) {
                    const questionText = document.createElement('p');
                    questionText.innerHTML = `<strong>${qIndex + 1}. ${question}</strong>`;
                    questionDiv.appendChild(questionText);
                }

                if (questionImg) {
                    const questionImage = document.createElement('img');
                    questionImage.src = questionImg;
                    questionImage.classList.add('question-img');
                    questionDiv.appendChild(questionImage);
                }

                const answersList = document.createElement('ul');
                answersList.classList.add('answers');
                answers.forEach(({ text, img }, varIndex) => {
                    const listItem = document.createElement('li');
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question-${uniqueId}`;
                    input.value = text;
                    input.dataset.varIndex = varIndex;

                    input.addEventListener('change', () => {
                        const response = JSON.stringify({
                            qIndex,
                            question,
                            answer: text,
                            varIndex,
                            clientId // This is the helper's clientId
                        });
                        console.log('Отправка ответа в helper:', response);
                        socket.send(response);

                        // Store the answer locally and update UI immediately
                        clientAnswers[clientId][qIndex] = { answer: text, varIndex: varIndex };
                        updateAnswerDisplay(clientId, qIndex, { varIndex: varIndex });
                    });

                    label.appendChild(input);
                    if (text) label.appendChild(document.createTextNode(` ${text}`));
                    if (img) {
                        const answerImage = document.createElement('img');
                        answerImage.src = img;
                        answerImage.classList.add('answer-img');
                        label.appendChild(answerImage);
                    }

                    listItem.appendChild(label);
                    answersList.appendChild(listItem);
                });

                questionDiv.appendChild(answersList);
                clientsData[clientId].appendChild(questionDiv);

                // If initial state includes an answer, select it
                if (userAnswer !== undefined) {
                    updateAnswerDisplay(clientId, qIndex, userAnswer);
                }
            }

            function updateAnswerDisplay(clientId, qIndex, userAnswer) {
                const uniqueId = `${clientId}-${qIndex}`;
                const questionDiv = clientsData[clientId]?.querySelector(`.question[data-unique-id="${uniqueId}"]`);
                if (questionDiv) {
                    const radioButtons = questionDiv.querySelectorAll(`input[name="question-${uniqueId}"]`);
                    radioButtons.forEach(radio => {
                        radio.checked = false; // Deselect all first
                        radio.parentNode.classList.remove('answered-question'); // Remove highlight
                        if (parseInt(radio.dataset.varIndex) === userAnswer.varIndex) {
                            radio.checked = true;
                            radio.parentNode.classList.add('answered-question'); // Highlight the selected answer
                        }
                    });
                }
            }

            function removeClient(clientId) {
                const clientSection = document.querySelector(`.client-section[data-client-id="${clientId}"]`);
                if (clientSection) {
                    clientSection.remove();
                    delete clientsData[clientId];
                    delete clientAnswers[clientId]; // Also remove answers for the disconnected client
                    console.log(`Клиент ${clientId} удален из интерфейса`);
                }
            }

            socket.onmessage = event => {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    console.error('Ошибка парсинга JSON:', e);
                    return;
                }

                if (data.type === 'initialState') {
                    data.exams.forEach(exam => {
                        exam.questions.forEach(question => {
                            const userAnswer = exam.answers.find(ans => ans.qIndex === question.qIndex);
                            renderExam({
                                clientId: exam.clientId,
                                userInfo: exam.userInfo,
                                question: question.question,
                                questionImg: question.questionImg,
                                qIndex: question.qIndex,
                                answers: question.answers,
                                timer: exam.timer,
                                userAnswer: userAnswer // Pass the stored answer
                            });
                        });
                    });
                    return;
                }

                if (data.type === 'clientDisconnected') {
                    removeClient(data.clientId);
                    return;
                }

                if (data.type === 'timerUpdate') {
                    const clientSection = document.querySelector(`.client-section[data-client-id="${data.clientId}"]`);
                    if (clientSection) {
                        const timerSpan = clientSection.querySelector('.timer');
                        if (timerSpan) {
                            timerSpan.textContent = data.timer;
                        }
                    }
                    return;
                }

                // New handler for user's own answers from any exam client
                if (data.type === 'userAnswer') {
                    console.log('Received userAnswer:', data);
                    clientAnswers[data.clientId] = clientAnswers[data.clientId] || {};
                    clientAnswers[data.clientId][data.qIndex] = { answer: data.answer, varIndex: data.varIndex };
                    updateAnswerDisplay(data.clientId, data.qIndex, { varIndex: data.varIndex });
                    return;
                }

                if (data.clientId && (data.question || data.questionImg) && data.answers) {
                    renderExam(data);
                }
            };

            socket.onerror = (error) => {
                console.error('Ошибка WebSocket:', error);
            };

            socket.onclose = () => {
                console.log('WebSocket соединение закрыто');
            };
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'946d89a73c1b2d92',t:'MTc0ODQzMzA2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'946df15019d05430',t:'MTc0ODQzNzMwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>
