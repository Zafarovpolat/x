<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сайт-помощник</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <section class="main">
        <div class="container">
            <div id="auth-check" style="display: none;">
                <h2>Требуется авторизация</h2>
                <p>Пожалуйста, <a href="./index.html">войдите</a> для доступа к помощнику.</p>
            </div>
            <div id="exam-content" style="display: none;">
                <h2>Помощник для экзамена</h2>
                <div id="clients"></div>
            </div>
        </div>
    </section>

    <script>
        if (localStorage.getItem('isAuthenticated') !== 'true') {
            document.getElementById('auth-check').style.display = 'block';
        } else {
            document.getElementById('exam-content').style.display = 'block';
            startExam();
        }

        function startExam() {
            const socket = new WebSocket('wss://x-q63z.onrender.com');
            const clientsDiv = document.getElementById('clients');
            const clientsData = {};

            socket.onopen = () => {
                console.log('WebSocket подключен на сайте-помощнике');
                socket.send(JSON.stringify({ role: 'exam' }));
            };

            function renderExam(data) {
                const { clientId, userInfo, question, questionImg, qIndex, answers, timer } = data;

                let clientSection = document.querySelector(`.client-section[data-client-id="${clientId}"]`);
                if (!clientSection) {
                    clientSection = document.createElement('div');
                    clientSection.classList.add('client-section');
                    clientSection.dataset.clientId = clientId;

                    const headerDiv = document.createElement('div');
                    headerDiv.classList.add('client-header');

                    const toggleButton = document.createElement('button');
                    const timerSpan = document.createElement('span');
                    timerSpan.classList.add('timer');
                    timerSpan.textContent = timer || '00:00:00';

                    toggleButton.appendChild(document.createTextNode(userInfo || `Клиент ${clientId}`));
                    toggleButton.appendChild(timerSpan);

                    toggleButton.addEventListener('click', () => {
                        const questionsDiv = clientSection.querySelector('.questions');
                        questionsDiv.style.display = (questionsDiv.style.display === 'none' || !questionsDiv.style.display) ? 'block' : 'none';
                    });

                    headerDiv.appendChild(toggleButton);

                    const questionsDiv = document.createElement('div');
                    questionsDiv.classList.add('questions');
                    questionsDiv.style.display = 'none';

                    clientSection.appendChild(headerDiv);
                    clientSection.appendChild(questionsDiv);
                    clientsDiv.appendChild(clientSection);

                    clientsData[clientId] = questionsDiv;
                } else if (timer) {
                    const timerSpan = clientSection.querySelector('.timer');
                    timerSpan.textContent = timer;
                }

                const uniqueId = `${clientId}-${qIndex}`;
                if (clientsData[clientId].querySelector(`.question[data-unique-id="${uniqueId}"]`)) return;

                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');
                questionDiv.dataset.uniqueId = uniqueId;

                if (question) {
                    const questionText = document.createElement('p');
                    questionText.innerHTML = `<strong>${qIndex + 1}. ${question}</strong>`;
                    questionDiv.appendChild(questionText);
                }

                if (questionImg) {
                    const questionImage = document.createElement('img');
                    questionImage.src = questionImg;
                    questionImage.classList.add('question-img');
                    questionDiv.appendChild(questionImage);
                }

                const answersList = document.createElement('ul');
                answersList.classList.add('answers');
                answers.forEach(({ text, img }, varIndex) => {
                    const listItem = document.createElement('li');
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question-${uniqueId}`;
                    input.value = text;
                    input.dataset.varIndex = varIndex;

                    input.addEventListener('change', () => {
                        const response = JSON.stringify({
                            qIndex,
                            question,
                            answer: text,
                            varIndex,
                            clientId
                        });
                        console.log('Отправка ответа в helper:', response);
                        socket.send(response);
                    });

                    label.appendChild(input);
                    if (text) label.appendChild(document.createTextNode(` ${text}`));
                    if (img) {
                        const answerImage = document.createElement('img');
                        answerImage.src = img;
                        answerImage.classList.add('answer-img');
                        label.appendChild(answerImage);
                    }

                    listItem.appendChild(label);
                    answersList.appendChild(listItem);
                });

                questionDiv.appendChild(answersList);
                clientsData[clientId].appendChild(questionDiv);
            }

            function updateAnswer(clientId, qIndex, varIndex) {
                const uniqueId = `${clientId}-${qIndex}`;
                const questionDiv = document.querySelector(`.question[data-unique-id="${uniqueId}"]`);
                if (questionDiv) {
                    const inputs = questionDiv.querySelectorAll(`input[name="question-${uniqueId}"]`);
                    inputs.forEach(input => {
                        if (parseInt(input.dataset.varIndex) === varIndex) {
                            input.checked = true;
                            input.parentElement.classList.add('selected-answer');
                        } else {
                            input.checked = false;
                            input.parentElement.classList.remove('selected-answer');
                        }
                    });
                    console.log(`Ответ обновлен для clientId: ${clientId}, qIndex: ${qIndex}, varIndex: ${varIndex}`);
                } else {
                    console.log(`Вопрос не найден: ${uniqueId}`);
                }
            }

            function removeClient(clientId) {
                const clientSection = document.querySelector(`.client-section[data-client-id="${clientId}"]`);
                if (clientSection) {
                    clientSection.remove();
                    delete clientsData[clientId];
                    console.log(`Клиент ${clientId} удален из интерфейса`);
                }
            }

            socket.onmessage = event => {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    console.error('Ошибка парсинга JSON:', e);
                    return;
                }

                console.log('Получено сообщение:', data);

                if (data.type === 'initialState') {
                    data.exams.forEach(exam => {
                        exam.questions.forEach(question => {
                            renderExam({
                                clientId: exam.clientId,
                                userInfo: exam.userInfo,
                                question: question.question,
                                questionImg: question.questionImg,
                                qIndex: question.qIndex,
                                answers: question.answers,
                                timer: exam.timer
                            });
                        });
                    });
                    return;
                }

                if (data.type === 'clientDisconnected') {
                    removeClient(data.clientId);
                    return;
                }

                if (data.type === 'timerUpdate') {
                    console.log('Получено timerUpdate:', data);
                    let clientSection = document.querySelector(`.client-section[data-client-id="${data.clientId}"]`);
                    if (!clientSection) {
                        console.log('Создание новой секции для clientId:', data.clientId);
                        clientSection = document.createElement('div');
                        clientSection.classList.add('client-section');
                        clientSection.dataset.clientId = data.clientId;

                        const headerDiv = document.createElement('div');
                        headerDiv.classList.add('client-header');

                        const toggleButton = document.createElement('button');
                        const timerSpan = document.createElement('span');
                        timerSpan.classList.add('timer');
                        timerSpan.textContent = data.timer;

                        toggleButton.appendChild(document.createTextNode(`Клиент ${data.clientId}`));
                        toggleButton.appendChild(timerSpan);

                        toggleButton.addEventListener('click', () => {
                            const questionsDiv = clientSection.querySelector('.questions');
                            questionsDiv.style.display = (questionsDiv.style.display === 'none' || !questionsDiv.style.display) ? 'block' : 'none';
                        });

                        headerDiv.appendChild(toggleButton);

                        const questionsDiv = document.createElement('div');
                        questionsDiv.classList.add('questions');
                        questionsDiv.style.display = 'none';

                        clientSection.appendChild(headerDiv);
                        clientSection.appendChild(questionsDiv);
                        clientsDiv.appendChild(clientSection);

                        clientsData[data.clientId] = questionsDiv;
                    } else {
                        const timerSpan = clientSection.querySelector('.timer');
                        if (timerSpan) {
                            timerSpan.textContent = data.timer;
                            console.log('Таймер обновлен для clientId:', data.clientId, 'время:', data.timer);
                        } else {
                            console.log('Элемент .timer не найден для clientId:', data.clientId);
                        }
                    }
                    return;
                }

                if (data.clientId && (data.question || data.questionImg) && data.answers) {
                    renderExam(data);
                }

                if (data.processedAnswer) {
                    updateAnswer(data.clientId, data.qIndex, data.varIndex);
                }
            };

            socket.onerror = (error) => {
                console.error('Ошибка WebSocket:', error);
            };

            socket.onclose = () => {
                console.log('WebSocket закрыт, пытаемся переподключиться');
                setTimeout(() => {
                    const newSocket = new WebSocket('wss://x-q63z.onrender.com');
                    newSocket.onopen = socket.onopen;
                    newSocket.onmessage = socket.onmessage;
                    newSocket.onerror = socket.onerror;
                    newSocket.onclose = socket.onclose;
                    socket = newSocket;
                }, 5000);
            };
        }
    </script>
</body>

</html>
